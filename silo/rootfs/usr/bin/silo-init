#!/command/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Silo Feed Reader - Initialization Script
# ==============================================================================

bashio::log.info "Initializing Silo Feed Reader..."

# Create data directories in HA's persistent storage
DATA_DIR="/data"
STORAGE_DIR="${DATA_DIR}/storage"
DB_DIR="${DATA_DIR}/db"

mkdir -p "${STORAGE_DIR}"
mkdir -p "${DB_DIR}"

# Symlink Rails directories to persistent locations
if [[ ! -L /rails/storage ]]; then
    rm -rf /rails/storage 2>/dev/null || true
    ln -sf "${STORAGE_DIR}" /rails/storage
fi

if [[ ! -L /rails/db ]]; then
    rm -rf /rails/db 2>/dev/null || true
    ln -sf "${DB_DIR}" /rails/db
fi

# Read configuration from Home Assistant options
TIMEZONE=$(bashio::config 'timezone')
LOG_LEVEL=$(bashio::config 'log_level')

# Auto-generate SECRET_KEY_BASE if not exists
if [[ -f "${DATA_DIR}/.secret_key_base" ]]; then
    SECRET_KEY_BASE=$(cat "${DATA_DIR}/.secret_key_base")
    bashio::log.info "Using existing SECRET_KEY_BASE"
else
    bashio::log.info "Generating new SECRET_KEY_BASE..."
    SECRET_KEY_BASE=$(openssl rand -hex 64)
    echo "${SECRET_KEY_BASE}" > "${DATA_DIR}/.secret_key_base"
    chmod 600 "${DATA_DIR}/.secret_key_base"
fi

# Auto-generate RAILS_MASTER_KEY if not exists
if [[ -f "${DATA_DIR}/.rails_master_key" ]]; then
    RAILS_MASTER_KEY=$(cat "${DATA_DIR}/.rails_master_key")
    bashio::log.info "Using existing RAILS_MASTER_KEY"
else
    bashio::log.info "Generating new RAILS_MASTER_KEY..."
    RAILS_MASTER_KEY=$(openssl rand -hex 16)
    echo "${RAILS_MASTER_KEY}" > "${DATA_DIR}/.rails_master_key"
    chmod 600 "${DATA_DIR}/.rails_master_key"
fi

# Generate admin credentials on first run
SILO_ADMIN_EMAIL=""
SILO_ADMIN_PASSWORD=""
if [[ ! -f "${DATA_DIR}/admin_credentials.json" ]]; then
    bashio::log.info "Generating admin credentials for first run..."
    SILO_ADMIN_PASSWORD=$(openssl rand -base64 12)
    SILO_ADMIN_EMAIL="admin@silo.local"
    cat > "${DATA_DIR}/admin_credentials.json" <<EOF
{
  "email": "${SILO_ADMIN_EMAIL}",
  "password": "${SILO_ADMIN_PASSWORD}",
  "created_at": "$(date -Iseconds)"
}
EOF
    chmod 600 "${DATA_DIR}/admin_credentials.json"
    bashio::log.info "Admin credentials generated and saved"
fi

# Get ingress path from Home Assistant
INGRESS_ENTRY=$(bashio::addon.ingress_entry)
bashio::log.info "Ingress entry path: ${INGRESS_ENTRY}"

# Set up environment variables for the Rails application
# Using s6-overlay environment directory
ENV_DIR="/var/run/s6/container_environment"
mkdir -p "${ENV_DIR}"

printf '%s' "${TIMEZONE}" > "${ENV_DIR}/TZ"
printf '%s' "production" > "${ENV_DIR}/RAILS_ENV"
printf '%s' "${LOG_LEVEL}" > "${ENV_DIR}/RAILS_LOG_LEVEL"
printf '%s' "5" > "${ENV_DIR}/RAILS_MAX_THREADS"
printf '%s' "${SECRET_KEY_BASE}" > "${ENV_DIR}/SECRET_KEY_BASE"
printf '%s' "${RAILS_MASTER_KEY}" > "${ENV_DIR}/RAILS_MASTER_KEY"
printf '%s' "1" > "${ENV_DIR}/RAILS_SERVE_STATIC_FILES"
printf '%s' "1" > "${ENV_DIR}/RAILS_LOG_TO_STDOUT"
printf '%s' "true" > "${ENV_DIR}/DISABLE_SSL"
printf '%s' "true" > "${ENV_DIR}/SOLID_QUEUE_IN_PUMA"
printf '%s' "8099" > "${ENV_DIR}/PORT"
printf '%s' "${INGRESS_ENTRY}" > "${ENV_DIR}/RAILS_RELATIVE_URL_ROOT"
printf '%s' "*" > "${ENV_DIR}/ACTION_CABLE_ALLOWED_REQUEST_ORIGINS"

bashio::log.info "Environment configured."
bashio::log.info "Running database migrations..."

# Export environment for migrations
export TZ="${TIMEZONE}"
export RAILS_ENV="production"
export RAILS_LOG_LEVEL="${LOG_LEVEL}"
export RAILS_MAX_THREADS="5"
export SECRET_KEY_BASE="${SECRET_KEY_BASE}"
export RAILS_MASTER_KEY="${RAILS_MASTER_KEY}"
export RAILS_SERVE_STATIC_FILES="1"
export RAILS_LOG_TO_STDOUT="1"
export DISABLE_SSL="true"
export SOLID_QUEUE_IN_PUMA="true"
export PORT="8099"
export RAILS_RELATIVE_URL_ROOT="${INGRESS_ENTRY}"

# Run database migrations
cd /rails || exit 1
./bin/rails db:prepare 2>&1 | while read -r line; do
    bashio::log.info "${line}"
done

# Run seeds to create admin user if credentials were just generated
if [[ -n "${SILO_ADMIN_EMAIL}" ]] && [[ -n "${SILO_ADMIN_PASSWORD}" ]]; then
    bashio::log.info "Creating admin user..."
    export SILO_ADMIN_EMAIL="${SILO_ADMIN_EMAIL}"
    export SILO_ADMIN_PASSWORD="${SILO_ADMIN_PASSWORD}"
    ./bin/rails db:seed 2>&1 | while read -r line; do
        bashio::log.info "${line}"
    done
fi

bashio::log.info "Silo initialization complete!"
